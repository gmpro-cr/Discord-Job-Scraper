{% extends "base.html" %}
{% block title %}Jobs - Job Search Agent{% endblock %}

{% block head %}
<style>
  .jobs-page {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
    background: #09090b;
    margin: -1.5rem;
    padding: 1.5rem;
    min-height: calc(100vh - 0rem);
  }
  .hc-mono { font-family: ui-monospace, 'SF Mono', SFMono-Regular, Menlo, Consolas, monospace; }
  /* Cards */
  .job-card {
    background: #18181b;
    border: 1px solid #27272a;
    border-radius: 16px;
    transition: box-shadow .18s, border-color .18s, transform .18s;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .job-card:hover { box-shadow: 0 8px 30px rgba(0,0,0,0.45); border-color: #52525b; transform: translateY(-2px); }
  /* Score badges */
  .score-high { background:#fafafa; color:#18181b; }
  .score-mid  { background:#451a03; color:#fbbf24; }
  .score-low  { background:#27272a; color:#71717a; }
  /* Tag pills */
  .tag-pill   { background:#27272a; border:1px solid #3f3f46; border-radius:999px; padding:2px 9px; font-size:11px; color:#a1a1aa; display:inline-block; }
  .tag-remote { background:#052e16; border:1px solid #166534; border-radius:999px; padding:2px 9px; font-size:11px; color:#4ade80; display:inline-block; }
  .tag-hybrid { background:#431407; border:1px solid #7c2d12; border-radius:999px; padding:2px 9px; font-size:11px; color:#fb923c; display:inline-block; }
  .tag-yoe    { background:#1e1b4b; border:1px solid #3730a3; border-radius:999px; padding:2px 9px; font-size:11px; color:#818cf8; display:inline-block; }
  /* Persona underline tabs */
  .persona-tab { transition: color .12s, border-color .12s; border-bottom: 2px solid transparent; padding-bottom: 10px; }
  .persona-tab.active { color: #fafafa; border-bottom-color: #fafafa; }
  .persona-tab:not(.active) { color: #52525b; }
  .persona-tab:not(.active):hover { color: #a1a1aa; }
  /* Buttons */
  .apply-btn { background:#fafafa; color:#18181b; transition:background .12s; border-radius:8px; }
  .apply-btn:hover { background:#d4d4d8; }
  .filter-submit { background:#fafafa; color:#18181b; transition:background .12s; }
  .filter-submit:hover { background:#d4d4d8; }
  /* Filter bar dark override */
  #filter-form { background:#18181b !important; border-color:#27272a !important; }
  #filter-form input, #filter-form select { background:#27272a !important; border-color:#3f3f46 !important; color:#e4e4e7 !important; }
  #filter-form input::placeholder { color:#71717a; }
  #filter-form .border-gray-100 { border-color:#27272a !important; }
  /* Card select + more btn */
  .card-select { background:#27272a; border:1px solid #3f3f46; color:#a1a1aa; border-radius:8px; font-size:12px; cursor:pointer; }
  .card-more-btn { background:transparent; border:1px solid #3f3f46; color:#71717a; border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer; }
  .card-more-btn:hover { background:#27272a; border-color:#52525b; color:#a1a1aa; }
  /* Search tools panel dark */
  #search-tools-panel .bg-white { background:#18181b !important; border-color:#27272a !important; }
  #search-tools-panel .border-gray-100, #search-tools-panel .border-b { border-color:#27272a !important; }
  #search-tools-panel input { background:#27272a !important; border-color:#3f3f46 !important; color:#e4e4e7 !important; }
  #search-tools-panel input::placeholder { color:#71717a; }
  #search-tools-panel .text-gray-800 { color:#e4e4e7 !important; }
  #search-tools-panel .text-gray-400 { color:#71717a !important; }
</style>
{% endblock %}

{% block content %}
<div class="jobs-page">
<!-- Page Header -->
<div class="mb-4 flex items-center justify-between">
  <div>
    <h1 class="text-xl font-semibold text-zinc-100 tracking-tight">Jobs</h1>
    <p class="hc-mono text-xs text-zinc-500 mt-0.5">{{ total }} results</p>
  </div>
  <div class="flex items-center gap-2">
    <button onclick="toggleSection('search-tools-panel')" class="text-sm text-zinc-400 hover:text-zinc-100 flex items-center gap-1 px-3 py-1.5 rounded-lg border border-zinc-700 bg-zinc-800 hover:bg-zinc-700">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      Search
    </button>
  </div>
</div>

<!-- Search Tools Panel (collapsed by default) -->
<div id="search-tools-panel" class="hidden mb-4 space-y-3">
  <!-- Smart Search -->
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="px-4 pt-3 pb-2 flex items-center gap-2 border-b border-gray-100">
      <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
      </svg>
      <span class="text-sm font-semibold text-gray-800">Smart Search</span>
      <span class="text-xs text-gray-400">Ask in plain English</span>
    </div>
    <div id="nlp-chat-history" class="px-4 py-2 max-h-64 overflow-y-auto space-y-2" style="display:none;"></div>
    <div class="px-4 py-3">
      <form id="nlp-form" onsubmit="sendNlpQuery(event)" class="flex gap-2">
        <input type="text" id="nlp-input"
               placeholder='e.g. "remote PM jobs in Bangalore above 20 lakhs"'
               class="flex-1 text-sm rounded-lg border-gray-200 shadow-sm focus:border-indigo-400 focus:ring-indigo-400 border p-2"
               autocomplete="off">
        <button type="submit" id="nlp-send-btn"
                class="apply-btn px-3 py-2 text-sm font-semibold rounded-lg flex items-center gap-1">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Ask
        </button>
      </form>
    </div>
  </div>

  <!-- Live Search -->
  <div class="bg-white rounded-xl border border-gray-200 p-4">
    <p class="text-sm font-semibold text-gray-800 mb-3">Live Search</p>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
      <input type="text" id="search-query" placeholder="Job title or keyword"
             class="text-sm rounded-lg border-gray-200 shadow-sm focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <input type="text" id="search-location" placeholder="Location"
             class="text-sm rounded-lg border-gray-200 shadow-sm focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <button id="search-btn" onclick="startLiveSearch()"
              class="filter-submit px-4 py-2 text-sm font-semibold rounded-lg">
        Search Jobs
      </button>
    </div>
    <div id="search-progress" class="hidden mt-3 pt-3 border-t border-gray-100">
      <div class="flex items-center gap-2 mb-2">
        <svg id="search-spinner" class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span id="search-phase-text" class="text-sm text-gray-700">Starting...</span>
      </div>
      <div id="search-portal-list" class="space-y-0.5 mb-2"></div>
      <div id="search-summary" class="hidden flex gap-4 text-xs text-gray-500">
        <span>Scraped: <strong id="search-stat-total" class="text-gray-800">0</strong></span>
        <span>New: <strong id="search-stat-inserted" class="text-gray-800">0</strong></span>
        <span>Qualified: <strong id="search-stat-qualified" class="text-gray-800">0</strong></span>
      </div>
      <div id="search-error" class="hidden mt-1 text-sm text-red-500"></div>
    </div>
  </div>
</div>

<!-- Filter Bar -->
<form method="GET" action="{{ url_for('jobs') }}" class="bg-white rounded-xl border border-gray-200 p-3 mb-4" id="filter-form">
  <!-- Primary row (always visible) -->
  <div class="flex flex-wrap gap-2 items-center">
    <input type="text" name="search" value="{{ filters.search }}" placeholder="Search roles, companies..."
           class="flex-1 min-w-[160px] text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
    <select name="sort" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="score_desc" {% if filters.sort == 'score_desc' or not filters.sort %}selected{% endif %}>Best match</option>
      <option value="date_desc" {% if filters.sort == 'date_desc' %}selected{% endif %}>Newest</option>
      <option value="date_asc" {% if filters.sort == 'date_asc' %}selected{% endif %}>Oldest</option>
      <option value="company_asc" {% if filters.sort == 'company_asc' %}selected{% endif %}>Company A–Z</option>
    </select>
    <select name="remote" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="">All work types</option>
      <option value="remote" {% if filters.remote == 'remote' %}selected{% endif %}>Remote</option>
      <option value="hybrid" {% if filters.remote == 'hybrid' %}selected{% endif %}>Hybrid</option>
      <option value="on-site" {% if filters.remote == 'on-site' %}selected{% endif %}>On-site</option>
    </select>
    <select name="applied" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="">All status</option>
      <option value="none" {% if filters.applied == 'none' %}selected{% endif %}>New</option>
      <option value="saved" {% if filters.applied == 'saved' %}selected{% endif %}>Saved</option>
      <option value="applied" {% if filters.applied == 'applied' %}selected{% endif %}>Applied</option>
      <option value="phone_screen" {% if filters.applied == 'phone_screen' %}selected{% endif %}>Phone Screen</option>
      <option value="interview" {% if filters.applied == 'interview' %}selected{% endif %}>Interview</option>
      <option value="offer" {% if filters.applied == 'offer' %}selected{% endif %}>Offer</option>
      <option value="rejected" {% if filters.applied == 'rejected' %}selected{% endif %}>Rejected</option>
    </select>
    <button type="button" onclick="toggleSection('more-filters')"
            class="text-sm text-gray-500 hover:text-gray-800 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 flex items-center gap-1">
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L13 13.414V19a1 1 0 01-.553.894l-4 2A1 1 0 017 21v-7.586L3.293 6.707A1 1 0 013 6V4z"/></svg>
      More
    </button>
    <button type="submit" class="filter-submit px-4 py-2 text-sm font-semibold rounded-lg">
      Filter
    </button>
    {% if filters.search or filters.portal or filters.remote or filters.location or filters.recency or filters.applied or filters.experience or filters.salary_min or filters.salary_max or (filters.min_score and filters.min_score != '40') %}
    <a href="{{ url_for('jobs') }}" class="text-xs text-gray-400 hover:text-gray-600 px-2 py-2">Clear</a>
    {% endif %}
  </div>

  <!-- More filters (hidden by default) -->
  <div id="more-filters" class="hidden mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2">
    <select name="portal" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="">All portals</option>
      {% for p in portals %}
      <option value="{{ p }}" {% if filters.portal == p %}selected{% endif %}>{{ p }}</option>
      {% endfor %}
    </select>
    <select name="location" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="">All locations</option>
      {% for loc_name, loc_count in locations %}
      <option value="{{ loc_name }}" {% if filters.location == loc_name %}selected{% endif %}>{{ loc_name }} ({{ loc_count }})</option>
      {% endfor %}
    </select>
    <select name="recency" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="">Any time</option>
      <option value="24h" {% if filters.recency == '24h' %}selected{% endif %}>Last 24h</option>
      <option value="3d" {% if filters.recency == '3d' %}selected{% endif %}>Last 3 days</option>
      <option value="1w" {% if filters.recency == '1w' %}selected{% endif %}>Last week</option>
      <option value="1m" {% if filters.recency == '1m' %}selected{% endif %}>Last month</option>
    </select>
    <select name="experience" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="">All exp levels</option>
      <option value="0-3" {% if filters.experience == '0-3' %}selected{% endif %}>0–3 yrs</option>
      <option value="3-7" {% if filters.experience == '3-7' %}selected{% endif %}>3–7 yrs</option>
      <option value="7-12" {% if filters.experience == '7-12' %}selected{% endif %}>7–12 yrs</option>
      <option value="12+" {% if filters.experience == '12+' %}selected{% endif %}>12+ yrs</option>
    </select>
    <select name="min_score" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="0" {% if filters.min_score == '0' %}selected{% endif %}>Any score</option>
      <option value="30" {% if filters.min_score == '30' %}selected{% endif %}>Score ≥ 30</option>
      <option value="40" {% if filters.min_score == '40' %}selected{% endif %}>Score ≥ 40</option>
      <option value="60" {% if filters.min_score == '60' or not filters.min_score %}selected{% endif %}>Score ≥ 60</option>
      <option value="50" {% if filters.min_score == '50' %}selected{% endif %}>Score ≥ 50</option>
      <option value="65" {% if filters.min_score == '65' %}selected{% endif %}>Score ≥ 65</option>
      <option value="75" {% if filters.min_score == '75' %}selected{% endif %}>Score ≥ 75</option>
    </select>
    <input type="number" name="salary_min" value="{{ filters.salary_min }}" placeholder="Min salary (L)"
           class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
    <input type="number" name="salary_max" value="{{ filters.salary_max }}" placeholder="Max salary (L)"
           class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
    <select name="company_type" class="text-sm rounded-lg border-gray-200 focus:border-indigo-400 focus:ring-indigo-400 border p-2">
      <option value="">All companies</option>
      <option value="startup" {% if filters.company_type == 'startup' %}selected{% endif %}>Startup</option>
      <option value="corporate" {% if filters.company_type == 'corporate' %}selected{% endif %}>Corporate</option>
    </select>
  </div>
</form>

<!-- Persona Tabs -->
<div class="flex gap-6 mb-4 border-b border-zinc-800">
  <button data-persona="all" onclick="switchPersona('all', this)"
          class="persona-tab active text-sm font-medium -mb-px">
    All <span class="hc-mono text-xs ml-1" id="ptab-count-all">{{ total }}</span>
  </button>
  <button data-persona="pm" onclick="switchPersona('pm', this)"
          class="persona-tab text-sm font-medium -mb-px">
    Product Manager <span class="hc-mono text-xs ml-1" id="ptab-count-pm">…</span>
  </button>
  <button data-persona="analyst" onclick="switchPersona('analyst', this)"
          class="persona-tab text-sm font-medium -mb-px">
    Analyst <span class="hc-mono text-xs ml-1" id="ptab-count-analyst">…</span>
  </button>
  <button data-persona="ai" onclick="switchPersona('ai', this)"
          class="persona-tab text-sm font-medium -mb-px">
    AI / ML <span class="hc-mono text-xs ml-1" id="ptab-count-ai">…</span>
  </button>
</div>

<!-- Job List -->
{% if jobs %}
{% set avatar_colors = ['#6366f1','#0ea5e9','#10b981','#f59e0b','#8b5cf6','#ef4444','#06b6d4','#f97316'] %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="job-list">
  {% for job in jobs %}
  {% set s = job.applied_status | int %}
  {% set cv = job.cv_score | default(0) | int %}
  {% set score = job.relevance_score | int %}
  {% set avatar_bg = avatar_colors[loop.index0 % 8] %}

  <div class="job-card" id="job-{{ job.job_id }}" data-role="{{ job.role | lower }}">
    <div class="p-4 flex-1 flex flex-col">

      <!-- Row 1: Company avatar + name + portal + date + score -->
      <div class="flex items-start justify-between mb-3">
        <div class="flex items-center gap-2.5">
          <div class="w-9 h-9 rounded-xl flex-shrink-0 flex items-center justify-center text-sm font-bold text-white"
               style="background:{{ avatar_bg }}">
            {{ (job.company or '?')[0] | upper }}
          </div>
          <div>
            <p class="text-sm font-medium text-zinc-100 leading-tight">{{ job.company | truncate(22, true, '…') }}</p>
            <p class="hc-mono text-[10px] text-zinc-500 mt-0.5">{{ job.portal }}</p>
          </div>
        </div>
        <div class="flex flex-col items-end gap-1">
          {% if job.date_posted %}
          <span class="hc-mono text-[10px] text-zinc-500 relative-date" data-date="{{ job.date_posted }}">{{ job.date_posted }}</span>
          {% endif %}
          <span class="hc-mono text-xs font-bold tabular-nums px-2 py-0.5 rounded
            {% if score >= 80 %}score-high{% elif score >= 65 %}score-mid{% else %}score-low{% endif %}">
            {{ score }}
          </span>
        </div>
      </div>

      <!-- Row 2: Job title -->
      <h3 class="text-[15px] font-semibold text-zinc-50 leading-snug line-clamp-2 mb-3">{{ job.role }}</h3>

      <!-- Row 3: Location + work type tags -->
      <div class="flex flex-wrap items-center gap-1.5 mb-3">
        {% if job.location %}
        <span class="flex items-center gap-1 text-xs text-zinc-400">
          <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          {{ job.location | truncate(18, true, '…') }}
        </span>
        {% endif %}
        {% if job.remote_status == 'remote' %}<span class="tag-remote">Remote</span>
        {% elif job.remote_status == 'hybrid' %}<span class="tag-hybrid">Hybrid</span>
        {% else %}<span class="tag-pill">Onsite</span>{% endif %}
      </div>

      <!-- Row 4: Salary + YOE + funding stage -->
      <div class="flex flex-wrap items-center gap-1.5 mb-3">
        {% if job.salary %}
        <span class="hc-mono text-xs font-semibold text-emerald-400">{{ job.salary_currency or '₹' }}{{ job.salary }}</span>
        {% endif %}
        {% if job.experience_min is not none %}
        <span class="tag-yoe">{{ job.experience_min }}+ yrs</span>
        {% endif %}
        {% if job.company_funding_stage %}
        <span class="tag-pill">{{ job.company_funding_stage }}</span>
        {% endif %}
      </div>

      <!-- Row 5: Description snippet -->
      {% if job.job_description %}
      <p class="text-xs text-zinc-500 leading-relaxed line-clamp-2 mb-3 flex-1">{{ job.job_description }}</p>
      {% else %}<div class="flex-1"></div>{% endif %}

      <!-- Contact info if available -->
      {% if job.poster_email or job.poster_linkedin %}
      <div class="hc-mono text-[11px] flex flex-wrap gap-2 text-indigo-400 mb-2">
        {% if job.poster_name %}<span class="text-zinc-500">{{ job.poster_name }}</span>{% endif %}
        {% if job.poster_email %}<a href="mailto:{{ job.poster_email }}" class="hover:underline">{{ job.poster_email }}</a>{% endif %}
        {% if job.poster_linkedin %}<a href="{{ job.poster_linkedin }}" target="_blank" rel="noopener" class="hover:underline">LinkedIn</a>{% endif %}
      </div>
      {% endif %}

      <!-- CV match progress bar -->
      {% if cv > 0 %}
      <div class="flex items-center gap-1.5 mb-1">
        <div class="flex-1 h-1 rounded-full bg-zinc-800 overflow-hidden">
          <div class="h-full rounded-full {% if cv >= 70 %}bg-emerald-500{% elif cv >= 40 %}bg-amber-500{% else %}bg-zinc-600{% endif %}"
               style="width:{{ cv }}%"></div>
        </div>
        <span class="hc-mono text-[10px] text-zinc-500">{{ cv }}% match</span>
      </div>
      {% endif %}

    </div>

    <!-- Card footer: actions -->
    <div class="px-4 pb-4 pt-3 border-t border-zinc-800 flex items-center gap-1.5 flex-wrap">
      {% if job.apply_url %}
      <a href="{{ job.apply_url }}" target="_blank" rel="noopener"
         onclick="onApplyClick('{{ job.job_id }}')"
         data-apply-url="{{ job.apply_url }}"
         class="apply-btn px-3 py-1.5 text-xs font-semibold flex-shrink-0">Apply ↗</a>
      {% endif %}
      <select onchange="updateJobStatus('{{ job.job_id }}', this.value, this)"
              class="card-select px-2 py-1.5 h-[30px] flex-shrink-0">
        <option value="" disabled {% if s == 0 %}selected{% endif %}>Status…</option>
        <option value="1" {% if s == 1 %}selected{% endif %}>Applied</option>
        <option value="2" {% if s == 2 %}selected{% endif %}>Saved</option>
        <option value="3" {% if s == 3 %}selected{% endif %}>Phone Screen</option>
        <option value="4" {% if s == 4 %}selected{% endif %}>Interview</option>
        <option value="5" {% if s == 5 %}selected{% endif %}>Offer</option>
        <option value="6" {% if s == 6 %}selected{% endif %}>Rejected</option>
      </select>
      <button onclick="toggleCardMenu('{{ job.job_id }}')"
              id="more-btn-{{ job.job_id }}"
              class="card-more-btn" title="More actions">•••</button>
    </div>

    <!-- Secondary actions (expandable) -->
    <div id="card-menu-{{ job.job_id }}" class="hidden px-4 pb-3 flex items-center gap-1.5 flex-wrap border-t border-zinc-800 pt-2">
      <button onclick="toggleGapAnalysis('{{ job.job_id }}', this)"
              class="inline-flex items-center gap-1 px-2.5 py-1 text-xs rounded-lg border border-zinc-700 text-zinc-400 hover:bg-zinc-800">Gap Analysis</button>
      <button onclick="fetchTailoredPoints('{{ job.job_id }}', this)"
              class="inline-flex items-center gap-1 px-2.5 py-1 text-xs rounded-lg border border-zinc-700 text-zinc-400 hover:bg-zinc-800">Resume Tips</button>
      <button onclick="toggleNotes('{{ job.job_id }}')"
              id="notes-btn-{{ job.job_id }}"
              class="inline-flex items-center gap-1 px-2.5 py-1 text-xs rounded-lg border border-zinc-700 text-zinc-400 hover:bg-amber-900/30 hover:border-amber-800 hover:text-amber-400">
        Notes{% if job.user_notes %} <span class="w-1.5 h-1.5 rounded-full bg-amber-400 inline-block ml-0.5"></span>{% endif %}
      </button>
      <button onclick="hideJob('{{ job.job_id }}')"
              class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-lg border border-zinc-700 text-zinc-500 hover:bg-red-900/30 hover:text-red-400 hover:border-red-800">Hide</button>
    </div>

    <!-- Expanded panels -->
    <div id="gap-{{ job.job_id }}" class="hidden mx-4 mb-3 p-3 bg-zinc-800/50 rounded-xl border border-zinc-700 text-xs">
      <div class="flex items-center justify-between mb-2">
        <p class="font-semibold text-zinc-200">Gap Analysis</p>
        <div id="gap-score-{{ job.job_id }}" class="font-bold text-zinc-400"></div>
      </div>
      <div id="gap-content-{{ job.job_id }}" class="text-zinc-400 italic">Loading...</div>
    </div>

    <div id="tailored-{{ job.job_id }}" class="hidden mx-4 mb-3 p-3 bg-amber-950/30 rounded-xl border border-amber-900/50">
      <p class="text-xs font-semibold text-amber-400 mb-1.5">Tailored Resume Points</p>
      <ul id="tailored-list-{{ job.job_id }}" class="space-y-1 text-xs text-amber-300/80"></ul>
    </div>

    <div id="notes-{{ job.job_id }}" class="hidden mx-4 mb-3 p-3 bg-amber-950/20 rounded-xl border border-amber-900/40">
      <p class="text-xs font-semibold text-amber-400 mb-1.5">My Notes</p>
      <textarea id="notes-text-{{ job.job_id }}"
                class="w-full text-xs rounded-lg border border-zinc-700 focus:border-amber-700 focus:ring-0 p-2 bg-zinc-900 text-zinc-200 resize-none"
                rows="3"
                placeholder="Add interview notes, contacts, follow-up reminders...">{{ job.user_notes or '' }}</textarea>
      <div class="flex justify-end mt-1.5">
        <button onclick="saveNote('{{ job.job_id }}')"
                id="notes-save-{{ job.job_id }}"
                class="px-3 py-1 bg-amber-600 text-white text-xs font-semibold rounded-lg hover:bg-amber-700">Save</button>
      </div>
    </div>

  </div>
  {% endfor %}
</div>

{% else %}
<div class="rounded-xl border border-zinc-800 p-12 text-center" style="background:#18181b">
  <p class="text-zinc-400 text-sm">No jobs found.</p>
  <p class="hc-mono text-xs text-zinc-600 mt-1">Try broadening your filters or run a live search.</p>
</div>
{% endif %}
</div>{# close .jobs-page #}
{% endblock %}

{% block scripts %}
<script>
let searchPollInterval = null;

function toggleSection(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('hidden');
}

// Auto-show more-filters if any advanced filter is active
(function() {
  const params = new URLSearchParams(window.location.search);
  const advanced = ['portal', 'location', 'recency', 'experience', 'min_score', 'salary_min', 'salary_max', 'company_type'];
  if (advanced.some(k => params.get(k))) {
    const el = document.getElementById('more-filters');
    if (el) el.classList.remove('hidden');
  }
})();

const searchPhaseLabels = {
  starting: 'Starting search...',
  scraping: 'Scraping job portals...',
  analyzing: 'Analyzing and scoring jobs...',
  storing: 'Storing jobs...',
  enriching_contacts: 'Looking up contacts...',
  done: 'Complete!',
  error: 'Error occurred',
  idle: 'Idle',
};

function startLiveSearch() {
  const query = document.getElementById('search-query').value.trim();
  const location = document.getElementById('search-location').value.trim();
  if (!query && !location) { alert('Please enter a job title or location.'); return; }

  const btn = document.getElementById('search-btn');
  btn.disabled = true;
  btn.textContent = 'Starting...';
  btn.classList.add('opacity-50');

  fetch('/api/search/start', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({query, location}),
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      document.getElementById('search-progress').classList.remove('hidden');
      document.getElementById('search-error').classList.add('hidden');
      searchPollInterval = setInterval(pollSearchStatus, 2000);
      pollSearchStatus();
    } else {
      btn.disabled = false;
      btn.textContent = 'Search Jobs';
      btn.classList.remove('opacity-50');
      alert(data.error || 'Failed to start search');
    }
  })
  .catch(err => {
    btn.disabled = false;
    btn.textContent = 'Search Jobs';
    btn.classList.remove('opacity-50');
    alert('Network error: ' + err.message);
  });
}

function pollSearchStatus() {
  fetch('/api/search/status')
    .then(r => r.json())
    .then(s => {
      document.getElementById('search-phase-text').textContent = searchPhaseLabels[s.phase] || s.phase;

      const portalList = document.getElementById('search-portal-list');
      const portals = Object.entries(s.portal_progress || {});
      if (portals.length > 0) {
        portalList.innerHTML = portals.map(([name, info]) => {
          const icon = info.status === 'success' ? '✓' : '✗';
          const color = info.status === 'success' ? 'text-green-600' : 'text-red-500';
          return `<div class="flex justify-between text-xs py-0.5">
            <span class="${color} flex items-center gap-1">${icon} <span class="text-gray-700">${name}</span></span>
            <span class="text-gray-400">${info.count} jobs</span>
          </div>`;
        }).join('');
      }

      if (s.total_jobs > 0 || s.phase === 'done') {
        document.getElementById('search-summary').classList.remove('hidden');
        document.getElementById('search-stat-total').textContent = s.total_jobs;
        document.getElementById('search-stat-qualified').textContent = s.qualified_jobs;
        document.getElementById('search-stat-inserted').textContent = s.inserted;
      }

      if (s.phase === 'done') {
        clearInterval(searchPollInterval);
        document.getElementById('search-spinner').classList.add('hidden');
        document.getElementById('search-phase-text').textContent = 'Done! Refreshing...';
        setTimeout(() => { window.location.href = '/jobs?sort=score_desc&min_score=40'; }, 1000);
      }

      if (s.phase === 'error') {
        clearInterval(searchPollInterval);
        document.getElementById('search-spinner').classList.add('hidden');
        const errDiv = document.getElementById('search-error');
        errDiv.classList.remove('hidden');
        errDiv.textContent = s.error || 'Unknown error';
        const btn = document.getElementById('search-btn');
        btn.disabled = false;
        btn.textContent = 'Search Jobs';
        btn.classList.remove('opacity-50');
      }
    })
    .catch(err => console.error('Search poll error:', err));
}

fetch('/api/search/status')
  .then(r => r.json())
  .then(s => {
    if (s.running) {
      document.getElementById('search-tools-panel').classList.remove('hidden');
      document.getElementById('search-progress').classList.remove('hidden');
      const btn = document.getElementById('search-btn');
      btn.disabled = true;
      btn.textContent = 'Searching...';
      btn.classList.add('opacity-50');
      searchPollInterval = setInterval(pollSearchStatus, 2000);
      pollSearchStatus();
    }
  });

// Status metadata for in-place card updates
const STATUS_META = {
  0: {label: 'New',          badge: 'bg-gray-100 text-gray-500',       border: 'border-l-gray-300'},
  1: {label: 'Applied',      badge: 'bg-green-100 text-green-700',     border: 'border-l-green-400'},
  2: {label: 'Saved',        badge: 'bg-blue-100 text-blue-700',       border: 'border-l-blue-400'},
  3: {label: 'Phone Screen', badge: 'bg-cyan-100 text-cyan-700',       border: 'border-l-cyan-400'},
  4: {label: 'Interview',    badge: 'bg-orange-100 text-orange-700',   border: 'border-l-orange-400'},
  5: {label: 'Offer',        badge: 'bg-emerald-100 text-emerald-700', border: 'border-l-emerald-500'},
  6: {label: 'Rejected',     badge: 'bg-red-100 text-red-600',         border: 'border-l-red-400'},
};

function updateJobStatus(jobId, statusVal, selectEl) {
  if (!statusVal) return;
  const status = parseInt(statusVal);
  fetch(`/api/jobs/${jobId}/status`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({status}),
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) return;
    const meta = STATUS_META[status] || STATUS_META[0];
    showToast(`Marked as ${meta.label}`);
  })
  .catch(err => console.error('Error updating status:', err));
}

function onApplyClick(jobId) {
  // After a brief delay, nudge user to mark as Applied
  setTimeout(() => {
    showToastWithAction('Did you apply? Mark it →', 'Mark Applied', () => {
      updateJobStatus(jobId, '1');
      // Update the select element to show "Applied"
      const card = document.getElementById('job-' + jobId);
      if (card) {
        const sel = card.querySelector('select');
        if (sel) sel.value = '1';
      }
    });
  }, 1200);
}

let _toastTimer = null;
function showToast(msg, duration) {
  duration = duration || 2500;
  let toast = document.getElementById('_toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = '_toast';
    toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm px-4 py-2 rounded-full shadow-lg z-50 pointer-events-none';
    toast.style.transition = 'opacity 0.3s';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => { toast.style.opacity = '0'; }, duration);
}

function showToastWithAction(msg, actionLabel, onAction) {
  let toast = document.getElementById('_toast_action');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = '_toast_action';
    toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm px-4 py-2 rounded-full shadow-lg z-50 flex items-center gap-3';
    toast.style.transition = 'opacity 0.3s';
    document.body.appendChild(toast);
  }
  toast.innerHTML = `<span>${escapeHtml(msg)}</span>
    <button class="text-indigo-300 hover:text-white font-semibold underline" id="_toast_action_btn">${escapeHtml(actionLabel)}</button>
    <button class="text-gray-400 hover:text-white ml-1" id="_toast_action_close">✕</button>`;
  toast.style.opacity = '1';

  document.getElementById('_toast_action_btn').addEventListener('click', () => {
    onAction();
    toast.style.opacity = '0';
  });
  document.getElementById('_toast_action_close').addEventListener('click', () => {
    toast.style.opacity = '0';
  });

  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => { toast.style.opacity = '0'; }, 6000);
}

// Convert ISO dates to relative ("3 days ago")
function toRelativeDate(isoStr) {
  if (!isoStr) return '';
  const d = new Date(isoStr);
  if (isNaN(d)) return isoStr;
  const diffDays = Math.floor((Date.now() - d.getTime()) / 86400000);
  if (diffDays <= 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 14) return '1 week ago';
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  if (diffDays < 60) return '1 month ago';
  return `${Math.floor(diffDays / 30)} months ago`;
}

// Run relative date conversion on page load
document.querySelectorAll('.relative-date').forEach(el => {
  const rel = toRelativeDate(el.dataset.date);
  if (rel) el.textContent = rel;
});

// Filter form: strip empty params before submitting to keep URLs clean
const filterForm = document.getElementById('filter-form');
if (filterForm) {
  filterForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const data = new FormData(this);
    const params = new URLSearchParams();
    for (const [key, value] of data.entries()) {
      if (value && value !== '0') params.set(key, value);
    }
    window.location.href = '/jobs?' + params.toString();
  });
}

function toggleGapAnalysis(jobId, btn) {
  const panel = document.getElementById('gap-' + jobId);
  const content = document.getElementById('gap-content-' + jobId);
  const scoreEl = document.getElementById('gap-score-' + jobId);

  if (!panel.classList.contains('hidden')) {
    panel.classList.add('hidden');
    return;
  }

  panel.classList.remove('hidden');
  if (content.dataset.loaded) return;

  fetch(`/api/jobs/${jobId}/gap-analysis`)
    .then(r => r.json())
    .then(data => {
      content.dataset.loaded = '1';
      if (!data.ok) {
        content.innerHTML = `<span class="text-red-500">${escapeHtml(data.error || 'Failed to load')}</span>`;
        return;
      }

      const cvPct = data.cv_score || 0;
      scoreEl.textContent = `${cvPct}% match`;
      scoreEl.className = `text-xs font-bold ${cvPct >= 70 ? 'text-green-600' : cvPct >= 40 ? 'text-amber-600' : 'text-gray-400'}`;

      const matchedHtml = (data.matched_skills || []).length > 0
        ? `<div class="mb-2">
            <p class="font-semibold text-green-700 mb-1">✓ Matched (${data.matched_skills.length})</p>
            <div class="flex flex-wrap gap-1">${data.matched_skills.map(s =>
              `<span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded">${escapeHtml(s)}</span>`
            ).join('')}</div>
           </div>`
        : '';

      const missingHtml = (data.missing_skills || []).length > 0
        ? `<div class="mb-2">
            <p class="font-semibold text-red-600 mb-1">✗ Missing (${data.missing_skills.length})</p>
            <div class="flex flex-wrap gap-1">${data.missing_skills.map(s =>
              `<span class="px-1.5 py-0.5 bg-red-50 text-red-600 rounded border border-red-100">${escapeHtml(s)}</span>`
            ).join('')}</div>
           </div>`
        : '';

      const tipsHtml = (data.action_steps || []).length > 0
        ? `<div>
            <p class="font-semibold text-slate-600 mb-1">→ Action Steps</p>
            <ul class="space-y-1">${data.action_steps.map(t =>
              `<li class="text-slate-500">${t.replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-700">$1</strong>')}</li>`
            ).join('')}</ul>
           </div>`
        : '';

      content.innerHTML = matchedHtml + missingHtml + tipsHtml ||
        '<span class="text-slate-400">Upload your CV to see gap analysis.</span>';
    })
    .catch(err => {
      content.innerHTML = `<span class="text-red-500">Error: ${escapeHtml(err.message)}</span>`;
    });
}

function sendNlpQuery(e) {
  e.preventDefault();
  const input = document.getElementById('nlp-input');
  const query = input.value.trim();
  if (!query) return;

  const history = document.getElementById('nlp-chat-history');
  history.style.display = 'block';

  const userBubble = document.createElement('div');
  userBubble.className = 'flex justify-end';
  userBubble.innerHTML = `<div class="bg-indigo-600 text-white text-sm rounded-lg rounded-br-sm px-3 py-2 max-w-md">${escapeHtml(query)}</div>`;
  history.appendChild(userBubble);

  const loadingId = 'nlp-loading-' + Date.now();
  const loadingBubble = document.createElement('div');
  loadingBubble.id = loadingId;
  loadingBubble.className = 'flex justify-start';
  loadingBubble.innerHTML = `<div class="bg-gray-100 text-gray-600 text-sm rounded-lg rounded-bl-sm px-3 py-2">
    <span class="inline-flex items-center gap-1"><svg class="animate-spin h-3.5 w-3.5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg> Thinking...</span>
  </div>`;
  history.appendChild(loadingBubble);
  history.scrollTop = history.scrollHeight;

  input.value = '';
  const btn = document.getElementById('nlp-send-btn');
  btn.disabled = true;

  fetch('/api/nlp-search', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({query}),
  })
  .then(r => r.json())
  .then(data => {
    btn.disabled = false;
    const loading = document.getElementById(loadingId);
    if (loading) loading.remove();

    if (!data.ok) {
      appendNlpError(history, data.error || 'Search failed');
      return;
    }

    const resp = document.createElement('div');
    resp.className = 'flex justify-start';

    const tags = (data.filter_labels || []).map(label =>
      `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 cursor-pointer hover:bg-indigo-200" onclick="applyNlpFilter(this)">${escapeHtml(label)}</span>`
    ).join('');

    let jobsHtml = '';
    if (data.jobs && data.jobs.length > 0) {
      const jobCards = data.jobs.slice(0, 8).map(job => {
        const scoreColor = job.relevance_score >= 75 ? 'text-green-700 bg-green-100'
          : job.relevance_score >= 50 ? 'text-yellow-700 bg-yellow-100'
          : 'text-gray-600 bg-gray-100';
        const remoteBadge = job.remote_status === 'remote'
          ? '<span class="text-xs text-green-700 bg-green-50 px-1 rounded">Remote</span>'
          : job.remote_status === 'hybrid'
          ? '<span class="text-xs text-yellow-700 bg-yellow-50 px-1 rounded">Hybrid</span>'
          : '';
        const salary = job.salary ? `<span class="text-xs text-green-700">${job.salary_currency || ''} ${job.salary}</span>` : '';
        return `<div class="py-2 border-b border-gray-100 last:border-0">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0 flex-1">
              <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(job.role)}</p>
              <p class="text-xs text-gray-500">${escapeHtml(job.company)}${job.location ? ' · ' + escapeHtml(job.location) : ''}</p>
              <div class="flex items-center gap-2 mt-0.5">${remoteBadge}${salary}</div>
            </div>
            <div class="flex-shrink-0 flex items-center gap-2">
              <span class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${scoreColor}">${job.relevance_score}</span>
              ${job.apply_url ? `<a href="${job.apply_url}" target="_blank" rel="noopener" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">Apply</a>` : ''}
            </div>
          </div>
        </div>`;
      }).join('');

      const moreCount = data.total > 8 ? `<p class="text-xs text-gray-400 pt-1">${data.total - 8} more. <a href="/jobs?${buildFilterQueryString(data.filters)}" class="text-indigo-600 hover:underline">View all ${data.total}</a></p>` : '';
      jobsHtml = `<div class="mt-2">${jobCards}${moreCount}</div>`;
    } else {
      jobsHtml = '<p class="text-sm text-gray-500 mt-2">No jobs found. Try broadening your search.</p>';
    }

    resp.innerHTML = `<div class="bg-gray-50 border border-gray-200 text-sm rounded-lg rounded-bl-sm px-4 py-3 max-w-lg w-full">
      <p class="text-xs font-medium text-gray-500 mb-1.5">I understood:</p>
      <div class="flex flex-wrap gap-1.5 mb-1">${tags || '<span class="text-xs text-gray-400">No specific filters detected</span>'}</div>
      <p class="text-sm font-medium text-gray-800 mt-2">${data.total} job${data.total !== 1 ? 's' : ''} found</p>
      ${jobsHtml}
      <div class="mt-2 pt-2 border-t border-gray-200">
        <a href="/jobs?${buildFilterQueryString(data.filters)}" class="text-xs font-medium text-indigo-600 hover:text-indigo-800">View all with filters →</a>
      </div>
    </div>`;

    history.appendChild(resp);
    history.scrollTop = history.scrollHeight;
  })
  .catch(err => {
    btn.disabled = false;
    const loading = document.getElementById(loadingId);
    if (loading) loading.remove();
    appendNlpError(history, 'Network error: ' + err.message);
  });
}

function appendNlpError(container, msg) {
  const errBubble = document.createElement('div');
  errBubble.className = 'flex justify-start';
  errBubble.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg rounded-bl-sm px-3 py-2">${escapeHtml(msg)}</div>`;
  container.appendChild(errBubble);
  container.scrollTop = container.scrollHeight;
}

function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function buildFilterQueryString(filters) {
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filters || {})) {
    if (value) params.set(key, value);
  }
  return params.toString();
}

function applyNlpFilter(el) {
  const text = el.textContent.trim();
  const current = new URLSearchParams(window.location.search);
  const match = text.match(/^(\w[\w\s]*?):\s*(.+)$/);
  if (match) {
    const key = match[1].toLowerCase().trim();
    const val = match[2].trim().replace(/"/g, '');
    const keyMap = {search:'search', location:'location', remote:'remote', company:'company_type', experience:'experience', status:'applied'};
    if (key === 'salary') {
      if (val.startsWith('>')) current.set('salary_min', val.replace(/[^0-9]/g, ''));
      else if (val.startsWith('<')) current.set('salary_max', val.replace(/[^0-9]/g, ''));
    } else if (keyMap[key]) {
      current.set(keyMap[key], val.toLowerCase());
    }
  }
  window.location.href = '/jobs?' + current.toString();
}

// ── Hide job ──────────────────────────────────────────────────────────────────
function hideJob(jobId) {
  fetch(`/api/jobs/${jobId}/hide`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({hidden: true}),
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) return;
    const card = document.getElementById('job-' + jobId);
    if (card) {
      card.style.transition = 'opacity 0.25s';
      card.style.opacity = '0';
      setTimeout(() => card.remove(), 280);
    }
    showToast('Job hidden · it won\'t show again');
  })
  .catch(err => console.error('Error hiding job:', err));
}

// ── Notes ─────────────────────────────────────────────────────────────────────
function toggleNotes(jobId) {
  const panel = document.getElementById('notes-' + jobId);
  if (!panel.classList.contains('hidden')) {
    panel.classList.add('hidden');
    return;
  }
  panel.classList.remove('hidden');
  panel.querySelector('textarea').focus();
}

function saveNote(jobId) {
  const textarea = document.getElementById('notes-text-' + jobId);
  const notes = textarea ? textarea.value : '';
  const btn = document.getElementById('notes-save-' + jobId);
  if (btn) { btn.textContent = '...'; btn.disabled = true; }

  fetch(`/api/jobs/${jobId}/notes`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({notes}),
  })
  .then(r => r.json())
  .then(data => {
    if (btn) { btn.textContent = 'Saved ✓'; btn.disabled = false; }
    setTimeout(() => { if (btn) btn.textContent = 'Save'; }, 2000);

    // Show/hide the yellow dot indicator on the Notes button
    const notesBtn = document.getElementById('notes-btn-' + jobId);
    if (notesBtn) {
      const dot = notesBtn.querySelector('span');
      if (notes.trim()) {
        if (!dot) {
          const d = document.createElement('span');
          d.className = 'w-1.5 h-1.5 rounded-full bg-yellow-400';
          notesBtn.appendChild(d);
        }
      } else if (dot) {
        dot.remove();
      }
    }
    showToast('Note saved');
  })
  .catch(err => {
    if (btn) { btn.textContent = 'Save'; btn.disabled = false; }
    console.error('Error saving note:', err);
  });
}

// ── Junk apply URL detection ──────────────────────────────────────────────────
function isJunkApplyUrl(url) {
  if (!url) return false;
  const u = url.toLowerCase();
  return (
    /naukri\.com\/[a-z][a-z-]+-jobs(\/|$|\?)/.test(u) ||        // naukri category pages
    /linkedin\.com\/jobs\/search/.test(u) ||                      // LinkedIn search
    /indeed\.com\/(jobs|viewjob)\?/.test(u) ||                    // Indeed search
    /glassdoor\.com\/job-listing\/[a-z]/.test(u) ||               // Glassdoor generic
    /\/jobs\/search/.test(u) ||                                    // generic /jobs/search paths
    /[?&](q|query|keyword|jobType)=/.test(u) && !/apply/.test(u)  // search params without apply
  );
}

// Flag generic search-page Apply buttons on page load
document.querySelectorAll('[data-apply-url]').forEach(el => {
  if (isJunkApplyUrl(el.getAttribute('data-apply-url'))) {
    // Replace button content text only, keep the SVG
    const svgEl = el.querySelector('svg');
    el.textContent = 'View Listing';
    if (svgEl) el.appendChild(svgEl);
    el.title = 'Links to a search page — you may need to find the specific listing manually';
    el.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    el.classList.add('bg-gray-500', 'hover:bg-gray-600');
  }
});

// ── Card menu (••• toggle) ────────────────────────────────────────────────────
function toggleCardMenu(jobId) {
  const menu = document.getElementById('card-menu-' + jobId);
  const btn = document.getElementById('more-btn-' + jobId);
  if (!menu) return;
  const isOpen = !menu.classList.contains('hidden');
  menu.classList.toggle('hidden', isOpen);
  if (btn) btn.classList.toggle('bg-gray-100', !isOpen);
}

// ── Persona Tabs ──────────────────────────────────────────────────────────────
const PERSONA_PATTERNS = {
  all:      null,
  pm:       /product\s*(manager|owner|lead|head|strategy|management)|associate\s*pm|\bapm\b/i,
  analyst:  /analyst/i,
  ai:       /\bai\b|machine\s*learning|\bml\b|artificial\s*intelligence|deep\s*learning|\bllm\b|generative/i,
};

function switchPersona(key, btn) {
  document.querySelectorAll('.persona-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');

  const pattern = PERSONA_PATTERNS[key];
  let visible = 0;
  document.querySelectorAll('.job-card').forEach(card => {
    const show = !pattern || pattern.test(card.dataset.role || '');
    card.style.display = show ? '' : 'none';
    if (show) visible++;
  });
  const countEl = document.querySelector('p.text-sm.text-gray-400');
  if (countEl) countEl.textContent = visible + ' results';
}

(function initPersonaCounts() {
  const cards = document.querySelectorAll('.job-card');
  const counts = { all: 0, pm: 0, analyst: 0, ai: 0 };
  cards.forEach(card => {
    const role = card.dataset.role || '';
    counts.all++;
    if (PERSONA_PATTERNS.pm.test(role))      counts.pm++;
    if (PERSONA_PATTERNS.analyst.test(role)) counts.analyst++;
    if (PERSONA_PATTERNS.ai.test(role))      counts.ai++;
  });
  ['all', 'pm', 'analyst', 'ai'].forEach(key => {
    const el = document.getElementById('ptab-count-' + key);
    if (el) el.textContent = counts[key];
  });
})();

function fetchTailoredPoints(jobId, btn) {
  const panel = document.getElementById('tailored-' + jobId);
  const list = document.getElementById('tailored-list-' + jobId);

  if (!panel.classList.contains('hidden')) {
    panel.classList.add('hidden');
    return;
  }

  btn.textContent = '...';
  btn.disabled = true;

  fetch(`/api/jobs/${jobId}/tailored-points`)
    .then(r => r.json())
    .then(data => {
      btn.textContent = 'Resume Tips';
      btn.disabled = false;
      if (data.ok && data.points) {
        list.innerHTML = data.points.map(p => `<li class="flex items-start"><span class="text-amber-600 mr-2">•</span><span>${p}</span></li>`).join('');
        panel.classList.remove('hidden');
      }
    })
    .catch(err => {
      btn.textContent = 'Resume Tips';
      btn.disabled = false;
      console.error('Error fetching tailored points:', err);
    });
}
</script>
{% endblock %}
