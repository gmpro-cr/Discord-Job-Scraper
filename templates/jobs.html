{% extends "base.html" %}
{% block title %}Jobs - Job Search Agent{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Jobs</h1>
    <p class="text-gray-500 mt-1">{{ total }} jobs found</p>
  </div>
</div>

<!-- NLP Chat Search -->
<div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
  <div class="px-5 pt-4 pb-2 border-b border-gray-100">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
      </svg>
      <h2 class="text-lg font-semibold text-gray-900">Smart Search</h2>
      <span class="text-xs text-gray-400 ml-1">Ask in plain English</span>
    </div>
  </div>

  <!-- Chat history -->
  <div id="nlp-chat-history" class="px-5 py-3 max-h-96 overflow-y-auto space-y-3" style="display:none;"></div>

  <!-- Input -->
  <div class="px-5 py-3">
    <form id="nlp-form" onsubmit="sendNlpQuery(event)" class="flex gap-2">
      <input type="text" id="nlp-input"
             placeholder="e.g. &quot;remote PM jobs in Bangalore above 20 lakhs&quot;"
             class="flex-1 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2.5"
             autocomplete="off">
      <button type="submit" id="nlp-send-btn"
              class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center gap-1.5">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
        </svg>
        Ask
      </button>
    </form>
    <p class="text-xs text-gray-400 mt-1.5">Try: "startup PM roles in Mumbai", "senior positions above 30 lakhs", "jobs I haven't applied to"</p>
  </div>
</div>

<!-- Live Search Section -->
<div class="bg-white rounded-lg shadow p-5 mb-6">
  <h2 class="text-lg font-semibold text-gray-900 mb-3">Live Search</h2>
  <p class="text-sm text-gray-500 mb-4">Scrape all portals for new jobs matching your query. Results appear below once complete.</p>
  <div id="search-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
    <div>
      <input type="text" id="search-query" placeholder="Job title or keyword (e.g. Product Manager)"
             class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
    </div>
    <div>
      <input type="text" id="search-location" placeholder="Location (e.g. Bangalore)"
             class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
    </div>
    <div>
      <button id="search-btn" onclick="startLiveSearch()"
              class="w-full px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
        Search Jobs
      </button>
    </div>
  </div>

  <!-- Live Search Progress (hidden initially) -->
  <div id="search-progress" class="hidden mt-4 pt-4 border-t border-gray-200">
    <div class="flex items-center space-x-3 mb-3">
      <svg id="search-spinner" class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span id="search-phase-text" class="text-sm font-medium text-gray-900">Starting...</span>
    </div>
    <div id="search-portal-list" class="space-y-1 mb-3"></div>
    <div id="search-summary" class="hidden grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
      <div><span class="text-gray-500">Scraped:</span> <span id="search-stat-total" class="font-medium">0</span></div>
      <div><span class="text-gray-500">Qualified:</span> <span id="search-stat-qualified" class="font-medium">0</span></div>
      <div><span class="text-gray-500">New:</span> <span id="search-stat-inserted" class="font-medium">0</span></div>
      <div><span class="text-gray-500">Duplicates:</span> <span id="search-stat-skipped" class="font-medium">0</span></div>
    </div>
    <div id="search-error" class="hidden mt-2 text-sm text-red-600"></div>
  </div>
</div>

<!-- Filter Bar -->
<form method="GET" action="{{ url_for('jobs') }}" class="bg-white rounded-lg shadow p-4 mb-6">
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
    <div class="col-span-2 sm:col-span-1">
      <input type="text" name="search" value="{{ filters.search }}" placeholder="Search roles, companies..."
             class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
    </div>
    <div>
      <select name="portal" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="">All Portals</option>
        {% for p in portals %}
        <option value="{{ p }}" {% if filters.portal == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <select name="remote" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="">All Remote</option>
        <option value="remote" {% if filters.remote == 'remote' %}selected{% endif %}>Remote</option>
        <option value="hybrid" {% if filters.remote == 'hybrid' %}selected{% endif %}>Hybrid</option>
        <option value="on-site" {% if filters.remote == 'on-site' %}selected{% endif %}>On-site</option>
      </select>
    </div>
    <div>
      <select name="company_type" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="">All Companies</option>
        <option value="startup" {% if filters.company_type == 'startup' %}selected{% endif %}>Startup</option>
        <option value="corporate" {% if filters.company_type == 'corporate' %}selected{% endif %}>Corporate</option>
      </select>
    </div>
    <div>
      <select name="location" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="">All Locations</option>
        {% for loc_name, loc_count in locations %}
        <option value="{{ loc_name }}" {% if filters.location == loc_name %}selected{% endif %}>{{ loc_name }} ({{ loc_count }})</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <select name="recency" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="">All Time</option>
        <option value="24h" {% if filters.recency == '24h' %}selected{% endif %}>Last 24 Hours</option>
        <option value="3d" {% if filters.recency == '3d' %}selected{% endif %}>Last 3 Days</option>
        <option value="1w" {% if filters.recency == '1w' %}selected{% endif %}>Last 1 Week</option>
        <option value="1m" {% if filters.recency == '1m' %}selected{% endif %}>Last 1 Month</option>
      </select>
    </div>
    <div>
      <select name="min_score" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="0" {% if filters.min_score == '0' %}selected{% endif %}>All Scores</option>
        <option value="30" {% if filters.min_score == '30' %}selected{% endif %}>Score >= 30</option>
        <option value="40" {% if filters.min_score == '40' or not filters.min_score %}selected{% endif %}>Score >= 40</option>
        <option value="50" {% if filters.min_score == '50' %}selected{% endif %}>Score >= 50</option>
        <option value="65" {% if filters.min_score == '65' %}selected{% endif %}>Score >= 65</option>
        <option value="75" {% if filters.min_score == '75' %}selected{% endif %}>Score >= 75</option>
      </select>
    </div>
    <div>
      <select name="sort" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="score_desc" {% if filters.sort == 'score_desc' %}selected{% endif %}>Score (high first)</option>
        <option value="score_asc" {% if filters.sort == 'score_asc' %}selected{% endif %}>Score (low first)</option>
        <option value="date_desc" {% if filters.sort == 'date_desc' %}selected{% endif %}>Newest first</option>
        <option value="date_asc" {% if filters.sort == 'date_asc' %}selected{% endif %}>Oldest first</option>
        <option value="company_asc" {% if filters.sort == 'company_asc' %}selected{% endif %}>Company A-Z</option>
      </select>
    </div>
    <div>
      <select name="experience" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="">All Experience</option>
        <option value="0-3" {% if filters.experience == '0-3' %}selected{% endif %}>0-3 years</option>
        <option value="3-7" {% if filters.experience == '3-7' %}selected{% endif %}>3-7 years</option>
        <option value="7-12" {% if filters.experience == '7-12' %}selected{% endif %}>7-12 years</option>
        <option value="12+" {% if filters.experience == '12+' %}selected{% endif %}>12+ years</option>
      </select>
    </div>
    <div>
      <input type="number" name="salary_min" value="{{ filters.salary_min }}" placeholder="Min salary (lakhs)"
             class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
    </div>
    <div>
      <input type="number" name="salary_max" value="{{ filters.salary_max }}" placeholder="Max salary (lakhs)"
             class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
    </div>
    <div>
      <select name="applied" class="w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
        <option value="">All Status</option>
        <option value="none" {% if filters.applied == 'none' %}selected{% endif %}>New</option>
        <option value="applied" {% if filters.applied == 'applied' %}selected{% endif %}>Applied</option>
        <option value="saved" {% if filters.applied == 'saved' %}selected{% endif %}>Saved</option>
        <option value="phone_screen" {% if filters.applied == 'phone_screen' %}selected{% endif %}>Phone Screen</option>
        <option value="interview" {% if filters.applied == 'interview' %}selected{% endif %}>Interview</option>
        <option value="offer" {% if filters.applied == 'offer' %}selected{% endif %}>Offer</option>
        <option value="rejected" {% if filters.applied == 'rejected' %}selected{% endif %}>Rejected</option>
      </select>
    </div>
    <div class="flex items-end">
      <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">
        Filter
      </button>
    </div>
  </div>
</form>

<!-- Job Cards -->
{% if jobs %}
<div class="space-y-3" id="job-list">
  {% for job in jobs %}
  {% set status_colors = {
    0: 'border-l-gray-300',
    1: 'border-l-green-400',
    2: 'border-l-blue-400',
    3: 'border-l-cyan-400',
    4: 'border-l-orange-400',
    5: 'border-l-emerald-500',
    6: 'border-l-red-400'
  } %}
  {% set status_labels = {
    0: ('New', 'bg-gray-100 text-gray-600'),
    1: ('Applied', 'bg-green-100 text-green-700'),
    2: ('Saved', 'bg-blue-100 text-blue-700'),
    3: ('Phone Screen', 'bg-cyan-100 text-cyan-700'),
    4: ('Interview', 'bg-orange-100 text-orange-700'),
    5: ('Offer', 'bg-emerald-100 text-emerald-700'),
    6: ('Rejected', 'bg-red-100 text-red-600')
  } %}
  {% set s = job.applied_status | int %}
  <div class="bg-white border border-gray-100 border-l-4 {{ status_colors.get(s, 'border-l-gray-300') }} rounded-xl shadow-sm hover:shadow-md transition-shadow"
       id="job-{{ job.job_id }}">
    <div class="p-5">

      <!-- Top row: badges + status pill -->
      <div class="flex items-start justify-between gap-3 mb-2">
        <div class="flex flex-wrap gap-1.5">
          <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-indigo-50 text-indigo-700">{{ job.portal }}</span>
          {% if job.remote_status == 'remote' %}
          <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-green-50 text-green-700">Remote</span>
          {% elif job.remote_status == 'hybrid' %}
          <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-amber-50 text-amber-700">Hybrid</span>
          {% else %}
          <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-600">On-site</span>
          {% endif %}
          {% if job.company_funding_stage %}
          <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-teal-50 text-teal-700">{{ job.company_funding_stage }}</span>
          {% endif %}
        </div>
        <!-- Status pill top-right -->
        {% set label_info = status_labels.get(s, ('New', 'bg-gray-100 text-gray-600')) %}
        <span class="flex-shrink-0 px-2.5 py-0.5 rounded-full text-xs font-semibold {{ label_info[1] }}">{{ label_info[0] }}</span>
      </div>

      <!-- Role + Company -->
      <h3 class="text-base font-semibold text-gray-900 leading-snug">{{ job.role }}</h3>
      <p class="text-sm text-gray-500 mt-0.5">
        {{ job.company }}
        {% if job.location %} &middot; {{ job.location }}{% endif %}
        {% if job.date_posted %} &middot; <span class="text-indigo-500">{{ job.date_posted }}</span>{% endif %}
      </p>

      <!-- Info row -->
      <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs text-gray-500">
        {% if job.salary %}<span class="text-green-700 font-medium">{{ job.salary_currency }} {{ job.salary }}</span>{% endif %}
        {% if job.experience_min is not none %}<span>{{ job.experience_min }}-{{ job.experience_max }}y exp</span>{% endif %}
        {% if job.company_size %}<span>{{ job.company_size }}</span>{% endif %}
      </div>

      <!-- CV Match Bar -->
      {% set cv = job.cv_score | default(0) | int %}
      <div class="mt-3">
        <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
          <span>CV Match</span>
          <span class="font-semibold {% if cv >= 70 %}text-green-700{% elif cv >= 40 %}text-amber-600{% else %}text-gray-400{% endif %}">{{ cv }}%</span>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-1.5">
          <div class="h-1.5 rounded-full {% if cv >= 70 %}bg-green-500{% elif cv >= 40 %}bg-amber-400{% else %}bg-gray-300{% endif %}"
               style="width: {{ cv }}%"></div>
        </div>
      </div>

      <!-- Description snippet -->
      {% if job.job_description %}
      <p class="text-xs text-gray-400 mt-2 line-clamp-2">{{ job.job_description[:180] }}{% if job.job_description|length > 180 %}...{% endif %}</p>
      {% endif %}

      <!-- Contact Info -->
      {% if job.poster_email or job.poster_linkedin %}
      <div class="mt-2 px-3 py-1.5 bg-blue-50 rounded-lg border border-blue-100 text-xs flex flex-wrap gap-x-3 gap-y-1">
        <span class="font-medium text-blue-700">Contact:</span>
        {% if job.poster_name %}<span class="text-blue-700">{{ job.poster_name }}</span>{% endif %}
        {% if job.poster_email %}<a href="mailto:{{ job.poster_email }}" class="text-blue-600 hover:underline">{{ job.poster_email }}</a>{% endif %}
        {% if job.poster_linkedin %}<a href="{{ job.poster_linkedin }}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">LinkedIn</a>{% endif %}
      </div>
      {% endif %}

      <!-- Actions row -->
      <div class="flex flex-wrap items-center gap-2 mt-3 pt-3 border-t border-gray-100">
        {% if job.apply_url %}
        <a href="{{ job.apply_url }}" target="_blank" rel="noopener"
           class="inline-flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700">
          Apply
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </a>
        {% endif %}

        <select onchange="updateJobStatus('{{ job.job_id }}', this.value)"
                class="text-xs rounded-lg border-gray-200 bg-gray-50 px-2 py-1.5 border focus:border-indigo-400 focus:ring-0 cursor-pointer">
          <option value="0" {% if s == 0 %}selected{% endif %}>Set Status</option>
          <option value="1" {% if s == 1 %}selected{% endif %}>Applied</option>
          <option value="2" {% if s == 2 %}selected{% endif %}>Save</option>
          <option value="3" {% if s == 3 %}selected{% endif %}>Phone Screen</option>
          <option value="4" {% if s == 4 %}selected{% endif %}>Interview</option>
          <option value="5" {% if s == 5 %}selected{% endif %}>Offer</option>
          <option value="6" {% if s == 6 %}selected{% endif %}>Rejected</option>
        </select>

        <button onclick="toggleGapAnalysis('{{ job.job_id }}', this)"
                class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-50">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Gap Analysis
        </button>

        <button onclick="fetchTailoredPoints('{{ job.job_id }}', this)"
                class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-50">
          Tailored Points
        </button>

        <span class="ml-auto text-xs text-gray-300 font-mono">{{ job.relevance_score }}pt</span>
      </div>

      <!-- Gap Analysis Panel (hidden by default) -->
      <div id="gap-{{ job.job_id }}" class="hidden mt-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
        <div class="flex items-center justify-between mb-3">
          <p class="text-xs font-semibold text-slate-700">Gap Analysis</p>
          <div id="gap-score-{{ job.job_id }}" class="text-xs font-bold text-slate-500"></div>
        </div>
        <div id="gap-content-{{ job.job_id }}" class="text-xs text-slate-500 italic">Loading...</div>
      </div>

      <!-- Tailored Points Panel (hidden by default) -->
      <div id="tailored-{{ job.job_id }}" class="hidden mt-3 p-4 bg-amber-50 rounded-xl border border-amber-200">
        <p class="text-xs font-semibold text-amber-800 mb-2">Tailored Resume Points</p>
        <ul id="tailored-list-{{ job.job_id }}" class="space-y-1 text-xs text-amber-900"></ul>
      </div>

    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="mt-6 flex items-center justify-center space-x-1">
  {% if page > 1 %}
  <a href="{{ url_for('jobs', page=page-1, **filters) }}"
     class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
    Prev
  </a>
  {% endif %}

  {% for p in range(1, total_pages + 1) %}
    {% if p == page %}
    <span class="px-3 py-2 text-sm font-medium text-white bg-indigo-600 border border-indigo-600 rounded-md">{{ p }}</span>
    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
    <a href="{{ url_for('jobs', page=p, **filters) }}"
       class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
      {{ p }}
    </a>
    {% elif p == page - 3 or p == page + 3 %}
    <span class="px-2 py-2 text-sm text-gray-400">...</span>
    {% endif %}
  {% endfor %}

  {% if page < total_pages %}
  <a href="{{ url_for('jobs', page=page+1, **filters) }}"
     class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
    Next
  </a>
  {% endif %}
</nav>
{% endif %}

{% else %}
<div class="bg-white rounded-lg shadow p-10 text-center">
  <p class="text-gray-500 text-lg">No jobs found matching your filters.</p>
  <p class="text-gray-400 text-sm mt-2">Try a live search above or adjust your filters.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
let searchPollInterval = null;

const searchPhaseLabels = {
  starting: 'Starting search...',
  scraping: 'Scraping job portals...',
  analyzing: 'Analyzing and scoring jobs...',
  storing: 'Storing jobs in database...',
  enriching_contacts: 'Looking up recruiter contacts...',
  done: 'Complete!',
  error: 'Error occurred',
  idle: 'Idle',
};

function startLiveSearch() {
  const query = document.getElementById('search-query').value.trim();
  const location = document.getElementById('search-location').value.trim();

  if (!query && !location) {
    alert('Please enter a job title/keyword or location.');
    return;
  }

  const btn = document.getElementById('search-btn');
  btn.disabled = true;
  btn.textContent = 'Starting...';
  btn.classList.add('opacity-50');

  fetch('/api/search/start', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({query, location}),
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      document.getElementById('search-progress').classList.remove('hidden');
      document.getElementById('search-error').classList.add('hidden');
      searchPollInterval = setInterval(pollSearchStatus, 2000);
      pollSearchStatus();
    } else {
      btn.disabled = false;
      btn.textContent = 'Search Jobs';
      btn.classList.remove('opacity-50');
      alert(data.error || 'Failed to start search');
    }
  })
  .catch(err => {
    btn.disabled = false;
    btn.textContent = 'Search Jobs';
    btn.classList.remove('opacity-50');
    alert('Network error: ' + err.message);
  });
}

function pollSearchStatus() {
  fetch('/api/search/status')
    .then(r => r.json())
    .then(s => {
      document.getElementById('search-phase-text').textContent = searchPhaseLabels[s.phase] || s.phase;

      // Portal progress
      const portalList = document.getElementById('search-portal-list');
      const portals = Object.entries(s.portal_progress || {});
      if (portals.length > 0) {
        portalList.innerHTML = portals.map(([name, info]) => {
          const icon = info.status === 'success'
            ? '<span class="text-green-600 font-bold">&#10003;</span>'
            : '<span class="text-red-500 font-bold">&#10007;</span>';
          return `<div class="flex items-center justify-between text-xs py-0.5">
            <span class="flex items-center space-x-2">
              ${icon}
              <span class="capitalize text-gray-700">${name}</span>
            </span>
            <span class="text-gray-500">${info.count} jobs</span>
          </div>`;
        }).join('');
      }

      // Summary stats
      if (s.total_jobs > 0 || s.phase === 'done') {
        document.getElementById('search-summary').classList.remove('hidden');
        document.getElementById('search-stat-total').textContent = s.total_jobs;
        document.getElementById('search-stat-qualified').textContent = s.qualified_jobs;
        document.getElementById('search-stat-inserted').textContent = s.inserted;
        document.getElementById('search-stat-skipped').textContent = s.skipped;
      }

      // Done - redirect to see fresh results
      if (s.phase === 'done') {
        clearInterval(searchPollInterval);
        document.getElementById('search-spinner').classList.add('hidden');
        document.getElementById('search-phase-text').textContent = 'Search complete! Redirecting...';
        setTimeout(() => {
          window.location.href = '/jobs?sort=score_desc&min_score=40';
        }, 1000);
      }

      // Error
      if (s.phase === 'error') {
        clearInterval(searchPollInterval);
        document.getElementById('search-spinner').classList.add('hidden');
        const errDiv = document.getElementById('search-error');
        errDiv.classList.remove('hidden');
        errDiv.textContent = s.error || 'Unknown error occurred';
        const btn = document.getElementById('search-btn');
        btn.disabled = false;
        btn.textContent = 'Search Jobs';
        btn.classList.remove('opacity-50');
      }
    })
    .catch(err => console.error('Search poll error:', err));
}

// Check if a search is already running on page load
fetch('/api/search/status')
  .then(r => r.json())
  .then(s => {
    if (s.running) {
      document.getElementById('search-progress').classList.remove('hidden');
      const btn = document.getElementById('search-btn');
      btn.disabled = true;
      btn.textContent = 'Searching...';
      btn.classList.add('opacity-50');
      searchPollInterval = setInterval(pollSearchStatus, 2000);
      pollSearchStatus();
    }
  });

function updateJobStatus(jobId, status) {
  if (!status || status === '0') return;
  fetch(`/api/jobs/${jobId}/status`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({status: parseInt(status)}),
  })
  .then(r => r.json())
  .then(data => { if (data.ok) window.location.reload(); })
  .catch(err => console.error('Error updating job status:', err));
}

function toggleGapAnalysis(jobId, btn) {
  const panel = document.getElementById('gap-' + jobId);
  const content = document.getElementById('gap-content-' + jobId);
  const scoreEl = document.getElementById('gap-score-' + jobId);

  if (!panel.classList.contains('hidden')) {
    panel.classList.add('hidden');
    return;
  }

  panel.classList.remove('hidden');

  if (content.dataset.loaded) return;

  fetch(`/api/jobs/${jobId}/gap-analysis`)
    .then(r => r.json())
    .then(data => {
      content.dataset.loaded = '1';
      if (!data.ok) {
        content.innerHTML = `<span class="text-red-500">${escapeHtml(data.error || 'Failed to load')}</span>`;
        return;
      }

      const cvPct = data.cv_score || 0;
      scoreEl.textContent = `${cvPct}% match`;
      scoreEl.className = `text-xs font-bold ${cvPct >= 70 ? 'text-green-600' : cvPct >= 40 ? 'text-amber-600' : 'text-gray-400'}`;

      const matchedHtml = (data.matched_skills || []).length > 0
        ? `<div class="mb-2">
            <p class="font-semibold text-green-700 mb-1">✓ Matched (${data.matched_skills.length})</p>
            <div class="flex flex-wrap gap-1">${data.matched_skills.map(s =>
              `<span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs">${escapeHtml(s)}</span>`
            ).join('')}</div>
           </div>`
        : '';

      const missingHtml = (data.missing_skills || []).length > 0
        ? `<div class="mb-2">
            <p class="font-semibold text-red-600 mb-1">✗ Missing (${data.missing_skills.length})</p>
            <div class="flex flex-wrap gap-1">${data.missing_skills.map(s =>
              `<span class="px-1.5 py-0.5 bg-red-50 text-red-600 rounded text-xs border border-red-100">${escapeHtml(s)}</span>`
            ).join('')}</div>
           </div>`
        : '';

      const tipsHtml = (data.action_steps || []).length > 0
        ? `<div>
            <p class="font-semibold text-slate-600 mb-1">→ Action Steps</p>
            <ul class="space-y-1">${data.action_steps.map(t =>
              `<li class="text-slate-500">${t.replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-700">$1</strong>')}</li>`
            ).join('')}</ul>
           </div>`
        : '';

      content.innerHTML = matchedHtml + missingHtml + tipsHtml ||
        '<span class="text-slate-400">Upload your CV to see gap analysis.</span>';
    })
    .catch(err => {
      content.innerHTML = `<span class="text-red-500">Error: ${escapeHtml(err.message)}</span>`;
    });
}

// ---- NLP Chat Search ----

function sendNlpQuery(e) {
  e.preventDefault();
  const input = document.getElementById('nlp-input');
  const query = input.value.trim();
  if (!query) return;

  const history = document.getElementById('nlp-chat-history');
  history.style.display = 'block';

  // Add user message bubble
  const userBubble = document.createElement('div');
  userBubble.className = 'flex justify-end';
  userBubble.innerHTML = `<div class="bg-indigo-600 text-white text-sm rounded-lg rounded-br-sm px-3 py-2 max-w-md">${escapeHtml(query)}</div>`;
  history.appendChild(userBubble);

  // Add loading bubble
  const loadingId = 'nlp-loading-' + Date.now();
  const loadingBubble = document.createElement('div');
  loadingBubble.id = loadingId;
  loadingBubble.className = 'flex justify-start';
  loadingBubble.innerHTML = `<div class="bg-gray-100 text-gray-600 text-sm rounded-lg rounded-bl-sm px-3 py-2">
    <span class="inline-flex items-center gap-1"><svg class="animate-spin h-3.5 w-3.5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg> Thinking...</span>
  </div>`;
  history.appendChild(loadingBubble);
  history.scrollTop = history.scrollHeight;

  input.value = '';
  const btn = document.getElementById('nlp-send-btn');
  btn.disabled = true;

  fetch('/api/nlp-search', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({query}),
  })
  .then(r => r.json())
  .then(data => {
    btn.disabled = false;
    const loading = document.getElementById(loadingId);
    if (loading) loading.remove();

    if (!data.ok) {
      appendNlpError(history, data.error || 'Search failed');
      return;
    }

    // Build response bubble
    const resp = document.createElement('div');
    resp.className = 'flex justify-start';

    // Filter tags
    const tags = (data.filter_labels || []).map(label =>
      `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 cursor-pointer hover:bg-indigo-200" onclick="applyNlpFilter(this)">${escapeHtml(label)}</span>`
    ).join('');

    // Job summary cards (compact)
    let jobsHtml = '';
    if (data.jobs && data.jobs.length > 0) {
      const jobCards = data.jobs.slice(0, 10).map(job => {
        const scoreColor = job.relevance_score >= 75 ? 'text-green-700 bg-green-100'
          : job.relevance_score >= 50 ? 'text-yellow-700 bg-yellow-100'
          : 'text-gray-600 bg-gray-100';
        const remoteBadge = job.remote_status === 'remote'
          ? '<span class="text-xs text-green-700 bg-green-50 px-1 rounded">Remote</span>'
          : job.remote_status === 'hybrid'
          ? '<span class="text-xs text-yellow-700 bg-yellow-50 px-1 rounded">Hybrid</span>'
          : '';
        const salary = job.salary ? `<span class="text-xs text-green-700">${job.salary_currency || ''} ${job.salary}</span>` : '';
        return `<div class="py-2 border-b border-gray-100 last:border-0">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0 flex-1">
              <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(job.role)}</p>
              <p class="text-xs text-gray-500">${escapeHtml(job.company)}${job.location ? ' &middot; ' + escapeHtml(job.location) : ''}</p>
              <div class="flex items-center gap-2 mt-0.5">${remoteBadge}${salary}</div>
            </div>
            <div class="flex-shrink-0 flex items-center gap-2">
              <span class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${scoreColor}">${job.relevance_score}</span>
              ${job.apply_url ? `<a href="${job.apply_url}" target="_blank" rel="noopener" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium whitespace-nowrap">Apply</a>` : ''}
            </div>
          </div>
        </div>`;
      }).join('');

      const moreCount = data.total > 10 ? `<p class="text-xs text-gray-400 pt-1">${data.total - 10} more jobs match. <a href="/jobs?${buildFilterQueryString(data.filters)}" class="text-indigo-600 hover:underline">View all ${data.total}</a></p>` : '';
      jobsHtml = `<div class="mt-2">${jobCards}${moreCount}</div>`;
    } else {
      jobsHtml = '<p class="text-sm text-gray-500 mt-2">No jobs found matching your query. Try broadening your search.</p>';
    }

    resp.innerHTML = `<div class="bg-gray-50 border border-gray-200 text-sm rounded-lg rounded-bl-sm px-4 py-3 max-w-lg w-full">
      <p class="text-xs font-medium text-gray-500 mb-1.5">I understood:</p>
      <div class="flex flex-wrap gap-1.5 mb-1">${tags || '<span class="text-xs text-gray-400">No specific filters detected</span>'}</div>
      <p class="text-sm font-medium text-gray-800 mt-2">${data.total} job${data.total !== 1 ? 's' : ''} found</p>
      ${jobsHtml}
      <div class="mt-2 pt-2 border-t border-gray-200">
        <a href="/jobs?${buildFilterQueryString(data.filters)}" class="text-xs font-medium text-indigo-600 hover:text-indigo-800">View full results with filters applied &rarr;</a>
      </div>
    </div>`;

    history.appendChild(resp);
    history.scrollTop = history.scrollHeight;
  })
  .catch(err => {
    btn.disabled = false;
    const loading = document.getElementById(loadingId);
    if (loading) loading.remove();
    appendNlpError(history, 'Network error: ' + err.message);
  });
}

function appendNlpError(container, msg) {
  const errBubble = document.createElement('div');
  errBubble.className = 'flex justify-start';
  errBubble.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg rounded-bl-sm px-3 py-2">${escapeHtml(msg)}</div>`;
  container.appendChild(errBubble);
  container.scrollTop = container.scrollHeight;
}

function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function buildFilterQueryString(filters) {
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filters || {})) {
    if (value) params.set(key, value);
  }
  return params.toString();
}

function applyNlpFilter(el) {
  // Parse the filter tag text and navigate to /jobs with that filter applied
  const text = el.textContent.trim();
  const current = new URLSearchParams(window.location.search);

  // Map label patterns back to filter params
  const match = text.match(/^(\w[\w\s]*?):\s*(.+)$/);
  if (match) {
    const key = match[1].toLowerCase().trim();
    const val = match[2].trim().replace(/"/g, '');
    const keyMap = {search:'search', location:'location', remote:'remote', company:'company_type', experience:'experience', status:'applied'};
    if (key === 'salary') {
      if (val.startsWith('>')) current.set('salary_min', val.replace(/[^0-9]/g, ''));
      else if (val.startsWith('<')) current.set('salary_max', val.replace(/[^0-9]/g, ''));
    } else if (keyMap[key]) {
      current.set(keyMap[key], val.toLowerCase());
    }
  }
  window.location.href = '/jobs?' + current.toString();
}

function fetchTailoredPoints(jobId, btn) {
  const panel = document.getElementById('tailored-' + jobId);
  const list = document.getElementById('tailored-list-' + jobId);

  // Toggle if already visible
  if (!panel.classList.contains('hidden')) {
    panel.classList.add('hidden');
    return;
  }

  btn.textContent = 'Loading...';
  btn.disabled = true;

  fetch(`/api/jobs/${jobId}/tailored-points`)
    .then(r => r.json())
    .then(data => {
      btn.textContent = 'Tailored Points';
      btn.disabled = false;
      if (data.ok && data.points) {
        list.innerHTML = data.points.map(p => `<li class="flex items-start"><span class="text-amber-600 mr-2">&#8226;</span><span>${p}</span></li>`).join('');
        panel.classList.remove('hidden');
      }
    })
    .catch(err => {
      btn.textContent = 'Tailored Points';
      btn.disabled = false;
      console.error('Error fetching tailored points:', err);
    });
}
</script>
{% endblock %}
