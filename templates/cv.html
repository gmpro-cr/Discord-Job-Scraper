{% extends "base.html" %}
{% block title %}CV — Job Search Agent{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-semibold text-gray-900">Your CV</h1>
  <p class="text-gray-500 mt-1 text-sm">Upload your CV to enable CV-based job scoring and gap analysis.</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

  <!-- Upload Section -->
  <div class="bg-white border border-gray-200 rounded-xl p-6">
    <h2 class="text-base font-semibold text-gray-900 mb-4">Upload CV</h2>

    {% if cv_data %}
    <!-- Compact status after upload -->
    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg mb-4">
      <div>
        <p class="text-sm font-medium text-green-800">✓ CV uploaded — {{ cv_data.skills | length }} skills detected</p>
        <p class="text-xs text-green-600 mt-0.5">Last updated: {{ cv_data.uploaded_at[:10] }}</p>
      </div>
      <button onclick="document.getElementById('cv-replace-zone').classList.toggle('hidden')"
              class="text-xs text-green-600 hover:text-green-800 font-medium underline ml-4 flex-shrink-0">
        Replace
      </button>
    </div>

    <!-- Replace dropzone (collapsed by default) -->
    <div id="cv-replace-zone" class="hidden mb-4">
      <div id="drop-zone"
           class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition-colors"
           onclick="document.getElementById('cv-file-input').click()"
           ondragover="event.preventDefault(); this.classList.add('border-indigo-500','bg-indigo-50')"
           ondragleave="this.classList.remove('border-indigo-500','bg-indigo-50')"
           ondrop="handleDrop(event)">
        <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <p class="text-sm font-medium text-gray-700">Drop new CV here or <span class="text-indigo-600">click to browse</span></p>
        <p class="text-xs text-gray-400 mt-1">PDF, DOCX, TXT</p>
      </div>
    </div>
    {% else %}
    <!-- Initial upload dropzone (when no CV yet) -->
    <div id="drop-zone"
         class="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition-colors mb-4"
         onclick="document.getElementById('cv-file-input').click()"
         ondragover="event.preventDefault(); this.classList.add('border-indigo-500','bg-indigo-50')"
         ondragleave="this.classList.remove('border-indigo-500','bg-indigo-50')"
         ondrop="handleDrop(event)">
      <svg class="mx-auto h-10 w-10 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      <p class="text-sm font-medium text-gray-700">Drop your CV here or <span class="text-indigo-600">click to browse</span></p>
      <p class="text-xs text-gray-400 mt-1">Supports PDF, DOCX, TXT</p>
    </div>
    {% endif %}

    <input type="file" id="cv-file-input" accept=".pdf,.docx,.txt" class="hidden" onchange="uploadCV(this.files[0])">
    <div id="upload-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>

    <button onclick="rescoreJobs()"
            class="mt-2 w-full px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50"
            id="rescore-btn" {% if not cv_data %}disabled title="Upload a CV first"{% endif %}>
      Re-score All Jobs Against CV
    </button>
    <div id="rescore-status" class="hidden mt-2 text-sm text-gray-600"></div>
  </div>

  <!-- Detected Skills -->
  <div class="bg-white border border-gray-200 rounded-xl p-6">
    <h2 class="text-base font-semibold text-gray-900 mb-4">Detected Skills</h2>
    {% if cv_data and cv_data.skills %}
    <div id="skills-list" class="space-y-4">
      <!-- Skills will be rendered by JS into groups; fallback shows all as one group -->
      <div id="skills-fallback" class="flex flex-wrap gap-2">
        {% for skill in cv_data.skills %}
        <span class="skill-pill inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100"
              data-skill="{{ skill | lower }}">
          {{ skill }}
        </span>
        {% endfor %}
      </div>
    </div>
    <p class="text-xs text-gray-400 mt-4">
      Skills are extracted from your CV and used to compute the CV match % on each job card.
      If a skill is missing, check that it appears clearly in your CV text.
    </p>
    {% else %}
    <div class="text-center py-8">
      <svg class="mx-auto h-10 w-10 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      <p class="text-gray-400 text-sm">No CV uploaded yet.</p>
      <p class="text-gray-300 text-xs mt-1">Skills will appear here after upload.</p>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function handleDrop(event) {
  event.preventDefault();
  document.getElementById('drop-zone').classList.remove('border-indigo-500', 'bg-indigo-50');
  const file = event.dataTransfer.files[0];
  if (file) uploadCV(file);
}

function uploadCV(file) {
  if (!file) return;
  const allowed = ['pdf', 'docx', 'txt'];
  const ext = file.name.split('.').pop().toLowerCase();
  if (!allowed.includes(ext)) {
    showStatus('upload-status', `Unsupported file type: .${ext}. Use PDF, DOCX, or TXT.`, 'error');
    return;
  }

  const formData = new FormData();
  formData.append('cv_file', file);

  showStatus('upload-status', 'Uploading and parsing CV...', 'info');

  fetch('/api/cv/upload', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
      if (data.ok) {
        showStatus('upload-status', `✓ CV parsed — ${data.skills_count} skills detected. Reloading...`, 'success');
        setTimeout(() => window.location.reload(), 1200);
      } else {
        showStatus('upload-status', `Error: ${data.error}`, 'error');
      }
    })
    .catch(err => showStatus('upload-status', `Network error: ${err.message}`, 'error'));
}

function rescoreJobs() {
  const btn = document.getElementById('rescore-btn');
  btn.disabled = true;
  btn.textContent = 'Rescoring...';
  const status = document.getElementById('rescore-status');
  status.classList.remove('hidden');
  status.textContent = 'Computing CV match scores for all jobs...';

  fetch('/api/cv/rescore', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.textContent = 'Re-score All Jobs Against CV';
      if (data.ok) {
        status.textContent = `✓ ${data.updated} jobs re-scored. Go to Jobs page to see CV match %.`;
        status.className = 'mt-2 text-sm text-green-700';
      } else {
        status.textContent = `Error: ${data.error}`;
        status.className = 'mt-2 text-sm text-red-600';
      }
    })
    .catch(err => {
      btn.disabled = false;
      btn.textContent = 'Re-score All Jobs Against CV';
      status.textContent = `Network error: ${err.message}`;
    });
}

function showStatus(id, msg, type) {
  const el = document.getElementById(id);
  el.classList.remove('hidden');
  el.className = `mt-4 p-3 rounded-lg text-sm ${
    type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
    type === 'error'   ? 'bg-red-50 text-red-700 border border-red-200' :
                         'bg-blue-50 text-blue-700 border border-blue-200'
  }`;
  el.textContent = msg;
}

// ── Skill grouping ─────────────────────────────────────────────────────────────
(function groupSkills() {
  const TECH = new Set([
    'sql', 'python', 'excel', 'figma', 'api', 'rest', 'git', 'github', 'ios', 'android',
    'java', 'javascript', 'typescript', 'react', 'node', 'go', 'rust', 'swift', 'kotlin',
    'docker', 'kubernetes', 'aws', 'gcp', 'azure', 'mongodb', 'redis', 'tableau', 'power bi',
    'powerbi', 'looker', 'dbt', 'airflow', 'spark', 'ml', 'nlp', 'ui', 'ux',
  ]);
  const DOMAIN = new Set([
    'lending', 'credit', 'banking', 'finance', 'fintech', 'insurance', 'payments',
    'nbfc', 'risk', 'compliance', 'audit', 'tax', 'accounting', 'treasury', 'ipo',
    'saas', 'b2b', 'b2c', 'e-commerce',
  ]);
  const AI_PRODUCT = new Set([
    'ai', 'analytics', 'a/b testing', 'metrics', 'kpi', 'okr', 'roadmap', 'prd',
    'product', 'mvp', 'user research', 'ux research',
  ]);

  const pills = document.querySelectorAll('.skill-pill');
  if (pills.length === 0) return;

  const groups = { tech: [], domain: [], ai_product: [], other: [] };
  pills.forEach(p => {
    const s = p.dataset.skill;
    if (TECH.has(s)) groups.tech.push(p);
    else if (AI_PRODUCT.has(s)) groups.ai_product.push(p);
    else if (DOMAIN.has(s)) groups.domain.push(p);
    else groups.other.push(p);
  });

  const fallback = document.getElementById('skills-fallback');
  if (!fallback) return;
  fallback.innerHTML = '';

  const groupConfig = [
    { key: 'tech',       label: 'Technical',       pillClass: 'bg-blue-50 text-blue-700 border-blue-100' },
    { key: 'ai_product', label: 'Analytics & Product', pillClass: 'bg-violet-50 text-violet-700 border-violet-100' },
    { key: 'domain',     label: 'Domain & Industry',  pillClass: 'bg-purple-50 text-purple-700 border-purple-100' },
    { key: 'other',      label: 'Leadership & Process', pillClass: 'bg-gray-50 text-gray-600 border-gray-200' },
  ];

  groupConfig.forEach(({ key, label, pillClass }) => {
    const items = groups[key];
    if (items.length === 0) return;
    const section = document.createElement('div');
    section.innerHTML = `<p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">${label}</p>`;
    const wrap = document.createElement('div');
    wrap.className = 'flex flex-wrap gap-2';
    items.forEach(p => {
      p.className = `inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${pillClass}`;
      wrap.appendChild(p);
    });
    section.appendChild(wrap);
    fallback.appendChild(section);
  });
})();
</script>
{% endblock %}
